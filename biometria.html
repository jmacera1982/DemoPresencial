<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Numia Bank - T√≥tem de Atenci√≥n con Biometr√≠a</title>
  <link rel="icon" type="image/png" href="images/N.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --numia-azul: #863DFF;
      --numia-azul-oscuro: #060A27;
      --numia-success: #10b981;
      --numia-text: #1f2937;
      --numia-text-light: #6b7280;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f5f5f5;
      color: var(--numia-text);
      min-height: 100vh;
      display: flex;
      gap: 2rem;
      padding: 2rem;
      align-items: center;
      justify-content: center;
      margin: 0;
    }
    
    /* Contenedor del t√≥tem */
    .totem-container {
      max-width: 600px;
      width: 100%;
      background: white;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      position: relative;
      height: calc(100vh - 4rem);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    /* Header del t√≥tem */
    .totem-header {
      background: var(--numia-azul-oscuro);
      padding: 1.5rem 2rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
    }
    
    .totem-content {
      flex: 1;
      overflow: hidden;
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 0;
    }
    
    /* Pantalla de Biometr√≠a */
    .screen-biometria {
      width: 100%;
      max-width: 500px;
      text-align: center;
      display: block;
    }
    
    .screen-biometria.hidden {
      display: none;
    }
    
    /* Pantalla de C√°mara */
    .screen-camara {
      width: 100%;
      max-width: 500px;
      text-align: center;
      display: block;
    }
    
    .screen-camara.hidden {
      display: none;
    }
    
    .screen-camara h2 {
      font-size: 1rem;
      color: var(--numia-text);
      margin-bottom: 1rem;
      font-weight: 500;
    }
    
    .screen-biometria h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--numia-text);
      margin-bottom: 0.5rem;
    }
    
    .screen-biometria .subtitle {
      font-size: 0.95rem;
      color: var(--numia-text-light);
      margin-bottom: 1rem;
    }
    
    .info-box {
      background: #f8f9fa;
      border-left: 4px solid var(--numia-azul);
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      text-align: left;
    }
    
    .info-box h3 {
      color: var(--numia-azul);
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .info-box ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .info-box li {
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .btn-iniciar-atencion {
      background: var(--numia-azul);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      margin-top: 1.5rem;
    }
    
    .btn-iniciar-atencion:hover {
      background: #6d2dd9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(134, 61, 255, 0.4);
    }
    
    .btn-iniciar-atencion.validating {
      background: #6c757d !important;
      cursor: not-allowed;
      opacity: 0.7;
      pointer-events: none;
    }
    
    .btn-iniciar-atencion.validating .btn-text {
      opacity: 0;
    }
    
    .btn-iniciar-atencion .biometric-icon,
    .btn-iniciar-atencion .loading-spinner {
      display: none;
    }
    
    .btn-iniciar-atencion.validating .biometric-icon {
      display: inline-block !important;
      animation: pulse 1.5s infinite;
    }
    
    .btn-iniciar-atencion.validating .loading-spinner {
      display: inline-block !important;
      animation: spin 1s linear infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .biometric-icon-large {
      font-size: 4rem;
      margin-bottom: 1rem;
      animation: pulse 2s infinite;
      color: #f97316;
    }
    
    .biometric-text {
      font-size: 1rem;
      color: var(--numia-text);
      margin-bottom: 1rem;
      font-weight: 500;
    }
    
    .biometric-progress {
      width: 100%;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .biometric-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--numia-azul), #3b82f6);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    
    /* Estilos para la c√°mara */
    .camera-container {
      margin: 2rem 0;
      position: relative;
    }
    
    .camera-feed {
      width: 300px;
      height: 225px;
      background: #000;
      border-radius: 15px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
      position: relative;
      overflow: hidden;
    }
    
    .camera-loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(134, 61, 255, 0.3);
      border-top-color: var(--numia-azul);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      position: absolute;
      z-index: 2;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .camera-feed video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 150px;
      height: 150px;
      border: 3px solid var(--numia-azul);
      border-radius: 50%;
      animation: scan 2s infinite;
      pointer-events: none;
      z-index: 1;
    }
    
    @keyframes scan {
      0%, 100% {
        opacity: 0.3;
        transform: translate(-50%, -50%) scale(1);
        border-color: var(--numia-azul);
      }
      50% {
        opacity: 0.8;
        transform: translate(-50%, -50%) scale(1.1);
        border-color: #3b82f6;
      }
    }
    
    .camera-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }
    
    .camera-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .camera-btn {
      background: var(--numia-azul);
      color: white;
    }
    
    .camera-btn:hover {
      background: #6d2dd9;
      transform: translateY(-2px);
    }
    
    .camera-btn.secondary {
      background: #6b7280;
      color: white;
    }
    
    .camera-btn.secondary:hover {
      background: #4b5563;
    }
    
    /* Pantalla de opciones */
    .screen-opciones {
      width: 100%;
      max-width: 500px;
      text-align: center;
      display: none;
    }
    
    .screen-opciones.active {
      display: block;
    }
    
    .screen-opciones h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--numia-text);
      margin-bottom: 0.5rem;
    }
    
    .screen-opciones .subtitle {
      font-size: 0.95rem;
      color: var(--numia-text-light);
      margin-bottom: 1rem;
    }
    
    .opciones-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: stretch;
    }
    
    .opcion-card {
      background: white;
      border: 3px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .opcion-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    
    .opcion-card {
      border-color: var(--numia-azul);
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    }
    
    .opcion-card:hover {
      border-color: var(--numia-azul);
      box-shadow: 0 8px 24px rgba(134, 61, 255, 0.3);
    }
    
    .opcion-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: var(--numia-azul);
    }
    
    .opcion-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--numia-text);
      margin-bottom: 0.25rem;
    }
    
    /* Pantalla de confirmaci√≥n */
    .screen-confirmacion {
      width: 100%;
      max-width: 500px;
      text-align: center;
      display: none;
    }
    
    .screen-confirmacion.active {
      display: block;
    }
    
    .success-icon {
      font-size: 4rem;
      color: var(--numia-success);
      margin-bottom: 1rem;
    }
    
    .screen-confirmacion h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--numia-text);
      margin-bottom: 1rem;
    }
    
    .message {
      font-size: 1rem;
      color: var(--numia-text-light);
      margin-bottom: 1.5rem;
    }
    
    /* Panel de logs del agente */
    .log-container {
      flex: 1;
      min-width: 400px;
      max-width: 500px;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      height: calc(100vh - 4rem);
      overflow: hidden;
    }
    
    .log-container.visible {
      display: flex;
    }
    
    .log-header {
      background: #2d2d2d;
      padding: 1rem 1.5rem;
      color: #ffffff;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      font-weight: 600;
      border-bottom: 2px solid #ffffff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    
    .log-header::before {
      content: '‚ñ∂';
      color: #ffffff;
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    
    .log-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .log-content::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    
    .log-content::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }
    
    .log-content::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
    
    .atencion-section {
      background: transparent !important;
      border-radius: 0;
      padding: 0;
      margin: 0;
      box-shadow: none;
      display: none;
    }
    
    .atencion-section.active {
      display: block;
    }
    
    .atencion-section .section-title {
      color: #ffffff;
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #333;
      padding-bottom: 0.5rem;
    }
    
    .steps-container {
      margin: 0;
    }
    
    .step-item {
      background: #2d2d2d;
      border-left: 3px solid #ffffff;
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
    }
    
    .step-item.completed {
      border-left-color: #ffffff;
      background: #2d2d2d;
    }
    
    .step-item.processing {
      border-left-color: #ffaa00;
      background: #3a2e1e;
    }
    
    .step-title {
      color: #ffffff;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .step-output-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 0.75rem;
      margin-top: 0.5rem;
      color: #ffffff;
    }
    
    .summary-section {
      background: #2d2d2d;
      border-left: 3px solid #ffffff;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1rem;
      color: #e0e0e0;
    }
    
    .summary-title {
      color: #ffffff;
      font-family: 'Courier New', monospace;
    }
    
    .summary-content {
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
    }
    
    @media (max-width: 1024px) {
      body {
        flex-direction: column;
        padding: 1rem;
      }
      
      .totem-container {
        max-width: 100%;
        height: 50vh;
      }
      
      .log-container {
        min-width: 100%;
        max-width: 100%;
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <!-- Contenedor del t√≥tem -->
  <div class="totem-container">
    <!-- Header -->
    <div class="totem-header">
      <img src="images/numia.png" alt="Numia" style="height: 40px; object-fit: contain;">
    </div>
    
    <!-- Contenido del t√≥tem -->
    <div class="totem-content">
      <!-- Pantalla inicial con bot√≥n -->
      <div class="screen-biometria" id="screenBiometria">
        <h2>Reconocimiento Facial</h2>
        <p class="subtitle">Por favor, mire hacia la c√°mara</p>
        
        <div class="info-box">
          <h3>üîí Validaci√≥n Biom√©trica con C√°mara</h3>|
          <p style="margin: 10px 0; font-size: 0.95rem;">
            Para garantizar la seguridad de la atenci√≥n, se requiere validaci√≥n biom√©trica mediante reconocimiento facial. 
            El sistema solicitar√° acceso a la c√°mara del totem para verificar su identidad.
          </p>
          <ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9rem;">
           
            <li>Posicione su rostro en el centro del c√≠rculo</li>
            <li>Mantenga una expresi√≥n neutra durante el escaneo</li>
            <li>No se almacenan im√°genes, solo se procesan temporalmente</li>
          </ul>
        </div>
        
        <!-- Bot√≥n de inicio -->
        <button class="btn-iniciar-atencion" id="btnIniciarAtencion" onclick="mostrarPantallaCamara()">
          <span class="btn-text">Iniciar Atenci√≥n</span>
        </button>
        <p style="margin-top: 15px; font-size: 0.9rem; color: var(--numia-text-light); text-align: center;">
          Se requiere validaci√≥n biom√©trica con c√°mara para continuar
        </p>
      </div>
      
      <!-- Pantalla de C√°mara -->
      <div class="screen-camara hidden" id="screenCamara">
        <div class="biometric-icon-large" id="biometricIcon">üîí</div>
        <h2 id="biometricText">Se requiere acceso a la c√°mara para validaci√≥n facial</h2>
        
        <!-- Contenedor de la c√°mara -->
        <div class="camera-container" id="cameraContainer">
          <div class="camera-feed" id="cameraFeed">
            <div>Iniciando c√°mara...</div>
            <div class="camera-loading-spinner"></div>
          </div>
          <div class="camera-overlay" id="cameraOverlay"></div>
        </div>
        
        <div class="biometric-progress">
          <div class="biometric-progress-fill" id="biometricProgress"></div>
        </div>
        
        <!-- Controles de la c√°mara -->
        <div class="camera-controls" id="cameraControls">
          <button class="camera-btn" onclick="startCamera()">Activar C√°mara</button>
        </div>
      </div>
      
      <!-- Pantalla 2: Opciones de atenci√≥n -->
      <div class="screen-opciones" id="screenOpciones">
        <h2>¬øC√≥mo podemos ayudarlo?</h2>
        <div class="subtitle">Seleccione el servicio que necesita</div>
        
        <div class="opciones-grid" id="opcionesGrid">
          <!-- Se llenar√° din√°micamente -->
        </div>
      </div>
      
      <!-- Pantalla 3: Confirmaci√≥n -->
      <div class="screen-confirmacion" id="screenConfirmacion">
        <div class="success-icon">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h2>¬°Atenci√≥n solicitada!</h2>
        <div class="message">
          En breve uno de nuestros asesores lo atender√°.<br>
          Por favor, mant√©ngase en l√≠nea.
        </div>
      </div>
    </div>
  </div>
  
  <!-- Contenedor de Logs a la derecha -->
  <div class="log-container" id="logContainer">
    <div class="log-header">
      An√°lisis del Agente
    </div>
    <div class="log-content">
      <div id="atencionSection" class="atencion-section">
        <div id="stepsContainer" class="steps-container">
          <!-- Los pasos se agregar√°n aqu√≠ din√°micamente -->
        </div>
        
        <div id="summarySection" class="summary-section" style="display: none;">
          <div class="summary-title">
            <i class="bi bi-check-circle-fill"></i>
            Resumen del An√°lisis
          </div>
          <div id="summaryContent" class="summary-content"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let stream = null;
    let videoElement = null;
    let scanInterval = null;
    
    const screenBiometria = document.getElementById('screenBiometria');
    const screenCamara = document.getElementById('screenCamara');
    const screenOpciones = document.getElementById('screenOpciones');
    const screenConfirmacion = document.getElementById('screenConfirmacion');
    const opcionesGrid = document.getElementById('opcionesGrid');
    const btnIniciarAtencion = document.getElementById('btnIniciarAtencion');
    const logContainer = document.querySelector('.log-container');
    const atencionSection = document.getElementById('atencionSection');
    const stepsContainer = document.getElementById('stepsContainer');
    const summarySection = document.getElementById('summarySection');
    const summaryContent = document.getElementById('summaryContent');
    
    // Configuraci√≥n de la API Journey Builder
    const JOURNEY_API_URL = 'https://api.journeybuilder.numia.co/api/v1/run/38223ec2-6123-4e6e-862a-4945161ed221?stream=false';
    const JOURNEY_API_KEY = 'sk-WfTsCY302RrciqoVRYAZWruD9mpyPKatAo8GU8tyzIM';
    
    // Variables de estado
    let analisisCompletado = false;
    let recomendacionVideollamada = false;

    function mostrarPantallaCamara() {
      console.log('üöÄ Mostrando pantalla de c√°mara...');
      screenBiometria.classList.add('hidden');
      screenCamara.classList.remove('hidden');
    }

    async function startCamera() {
      console.log('üìπ Funci√≥n startCamera ejecut√°ndose...');
      try {
        // Solicitar acceso a la c√°mara
        console.log('üîê Solicitando acceso a la c√°mara...');
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 400 },
            height: { ideal: 300 },
            facingMode: 'user'
          } 
        });
        
        console.log('‚úÖ Acceso a la c√°mara concedido');
        
        // Crear elemento de video
        videoElement = document.createElement('video');
        videoElement.srcObject = stream;
        videoElement.autoplay = true;
        videoElement.playsInline = true;
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        videoElement.style.objectFit = 'cover';
        
        // Reemplazar el contenido del feed de la c√°mara
        const cameraFeed = document.getElementById('cameraFeed');
        const cameraOverlay = document.getElementById('cameraOverlay');
        if (cameraFeed) {
          cameraFeed.innerHTML = '';
          cameraFeed.appendChild(videoElement);
        }
        // Mantener el overlay visible
        if (cameraOverlay) {
          cameraOverlay.style.display = 'block';
        }
        
        // Actualizar estado
        const biometricIcon = document.getElementById('biometricIcon');
        if (biometricIcon) {
          biometricIcon.textContent = 'üëÅÔ∏è';
        }
        
        console.log('üì± C√°mara activada, iniciando escaneo facial en 2 segundos...');
        
        // Simular proceso de escaneo facial
        setTimeout(() => {
          console.log('üëÅÔ∏è Iniciando escaneo facial autom√°ticamente...');
          startFacialScan();
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Error al acceder a la c√°mara:', error);
        const biometricIcon = document.getElementById('biometricIcon');
        if (biometricIcon) {
          biometricIcon.textContent = '‚ùå';
        }
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      if (videoElement) {
        videoElement.remove();
        videoElement = null;
      }
      
      // Detener intervalo de escaneo si est√° activo
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      
      // Restaurar estado inicial
      const cameraFeed = document.getElementById('cameraFeed');
      if (cameraFeed) {
        cameraFeed.innerHTML = '<div>Iniciando c√°mara...</div><div class="camera-loading-spinner"></div>';
      }
      const biometricIcon = document.getElementById('biometricIcon');
      const biometricText = document.getElementById('biometricText');
      const biometricProgress = document.getElementById('biometricProgress');
      
      if (biometricIcon) biometricIcon.textContent = 'üîí';
      if (biometricText) biometricText.textContent = 'Se requiere acceso a la c√°mara para validaci√≥n facial';
      if (biometricProgress) biometricProgress.style.width = '0%';
    }

    function startFacialScan() {
      console.log('üëÅÔ∏è Iniciando escaneo facial...');
      const biometricIcon = document.getElementById('biometricIcon');
      const biometricText = document.getElementById('biometricText');
      
      if (biometricIcon) biometricIcon.textContent = 'üëÅÔ∏è';
      if (biometricText) biometricText.textContent = 'Escaneando rostro...';
      
      // Simular progreso del escaneo
      let progress = 0;
      scanInterval = setInterval(() => {
        progress += 10; // 10% cada vez
        updateBiometricProgress(progress);
        console.log(`üìä Progreso del escaneo: ${progress}%`);
        
        if (progress >= 100) {
          clearInterval(scanInterval);
          scanInterval = null;
          console.log('‚úÖ Escaneo facial completado');
          completeBiometricValidation();
        }
      }, 200); // 200ms cada paso
    }

    function completeBiometricValidation() {
      console.log('üéâ Validaci√≥n biom√©trica completada exitosamente');
      const biometricIcon = document.getElementById('biometricIcon');
      const biometricText = document.getElementById('biometricText');
      const cameraContainer = document.getElementById('cameraContainer');
      const cameraControls = document.getElementById('cameraControls');
      
      if (biometricIcon) biometricIcon.textContent = '‚úÖ';
      if (biometricText) biometricText.textContent = '¬°Validaci√≥n biom√©trica exitosa!';
      
      // Detener c√°mara
      stopCamera();
      
      // Ocultar controles de c√°mara
      if (cameraContainer) cameraContainer.style.display = 'none';
      if (cameraControls) cameraControls.style.display = 'none';
      
      // Continuar con el proceso despu√©s de 2 segundos
      setTimeout(() => {
        console.log('üîí Ocultando pantalla de c√°mara...');
        
        // Ocultar pantalla de c√°mara y mostrar men√∫ de opciones
        screenCamara.classList.add('hidden');
        mostrarPantallaOpciones();
      }, 2000);
    }

    function updateBiometricProgress(progress) {
      const biometricProgress = document.getElementById('biometricProgress');
      if (biometricProgress) {
        biometricProgress.style.width = progress + '%';
      }
    }
    
    // Mostrar pantalla de opciones (Pr√©stamos, Tarjetas, Inversiones)
    function mostrarPantallaOpciones() {
      screenOpciones.classList.add('active');
      
      opcionesGrid.innerHTML = '';
      
      // Opci√≥n Pr√©stamos
      const cardPrestamos = document.createElement('div');
      cardPrestamos.className = 'opcion-card';
      cardPrestamos.style.cssText = 'cursor: pointer; border-color: var(--numia-azul); background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);';
      cardPrestamos.innerHTML = `
        <div class="opcion-icon" style="color: var(--numia-azul);">
          <i class="bi bi-cash-coin"></i>
        </div>
        <div class="opcion-title">Pr√©stamos</div>
      `;
      cardPrestamos.addEventListener('click', async () => {
        await llamarAgenteConOpcionTotem('prestamos');
      });
      opcionesGrid.appendChild(cardPrestamos);
      
      // Opci√≥n Tarjetas
      const cardTarjetas = document.createElement('div');
      cardTarjetas.className = 'opcion-card';
      cardTarjetas.style.cssText = 'cursor: pointer; border-color: var(--numia-azul); background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);';
      cardTarjetas.innerHTML = `
        <div class="opcion-icon" style="color: var(--numia-azul);">
          <i class="bi bi-credit-card"></i>
        </div>
        <div class="opcion-title">Tarjetas</div>
      `;
      cardTarjetas.addEventListener('click', async () => {
        await llamarAgenteConOpcionTotem('tarjetas');
      });
      opcionesGrid.appendChild(cardTarjetas);
      
      // Opci√≥n Inversiones
      const cardInversiones = document.createElement('div');
      cardInversiones.className = 'opcion-card';
      cardInversiones.style.cssText = 'cursor: pointer; border-color: var(--numia-azul); background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);';
      cardInversiones.innerHTML = `
        <div class="opcion-icon" style="color: var(--numia-azul);">
          <i class="bi bi-graph-up-arrow"></i>
        </div>
        <div class="opcion-title">Inversiones</div>
      `;
      cardInversiones.addEventListener('click', async () => {
        await llamarAgenteConOpcionTotem('inversiones');
      });
      opcionesGrid.appendChild(cardInversiones);
    }
    
    async function llamarAgenteConOpcionTotem(opcion) {
      try {
        console.log(`üìû Llamando agente con opci√≥n: ${opcion}`);
        
        // Ocultar pantalla de opciones y mostrar loading
        screenOpciones.classList.remove('active');
        
        // Mostrar log
        if (logContainer) {
          logContainer.classList.add('visible');
        }
        
        if (atencionSection) {
          atencionSection.style.display = 'block';
          atencionSection.classList.add('active');
        }
        
        if (stepsContainer) {
          stepsContainer.innerHTML = '<div style="color: #ffffff;"><i class="bi bi-hourglass-split me-2"></i>Conectando con el asistente...</div>';
        }
        
        // Llamar al agente con la opci√≥n seleccionada
        const mensaje = `Necesito atenci√≥n sobre ${opcion}`;
        
        const response = await fetch(JOURNEY_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': JOURNEY_API_KEY,
            'Origin': 'journeybuilder.numia.co'
          },
          body: JSON.stringify({
            input_value: mensaje,
            input_type: 'chat'
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error en servidor (${response.status})`);
        }
        
        const data = await response.json();
        console.log('Respuesta completa de la API:', JSON.stringify(data, null, 2));
        
        // Procesar respuesta
        let contents = [];
        let messageText = null;
        
        if (data.outputs && data.outputs.length > 0) {
          const firstOutput = data.outputs[0];
          
          if (firstOutput.outputs && firstOutput.outputs.length > 0) {
            const innerOutput = firstOutput.outputs[0];
            
            if (innerOutput.results?.message?.content_blocks) {
              innerOutput.results.message.content_blocks.forEach((block) => {
                if (block.contents && Array.isArray(block.contents)) {
                  block.contents.forEach((content) => {
                    if (content.type === 'tool_use' && content.name) {
                      contents.push({
                        type: 'tool_use',
                        name: content.name,
                        tool_name: content.name,
                        tool_input: content.tool_input || content.input,
                        output: content.output,
                        duration: content.duration
                      });
                    }
                  });
                }
              });
            }
            
            if (innerOutput.artifacts?.message) {
              messageText = typeof innerOutput.artifacts.message === 'string' 
                ? innerOutput.artifacts.message 
                : innerOutput.artifacts.message.message || JSON.stringify(innerOutput.artifacts.message);
            } else if (innerOutput.outputs?.message?.message) {
              messageText = innerOutput.outputs.message.message;
            } else if (innerOutput.results?.message?.text) {
              messageText = innerOutput.results.message.text;
            }
          }
        }
        
        // Mostrar pasos
        if (contents.length > 0 && stepsContainer) {
          stepsContainer.innerHTML = '';
          contents.forEach((content, index) => {
            setTimeout(() => {
              agregarPaso(content, index);
            }, index * 800);
          });
          
          if (messageText) {
            setTimeout(() => {
              mostrarResumen(messageText);
              analisisCompletado = true;
              
              // Mostrar pantalla de confirmaci√≥n despu√©s del an√°lisis
              setTimeout(() => {
                screenConfirmacion.classList.add('active');
              }, contents.length * 800 + 500);
            }, contents.length * 800 + 500);
          }
        } else {
          if (messageText && summaryContent) {
            mostrarResumen(messageText);
            analisisCompletado = true;
            
            // Mostrar pantalla de confirmaci√≥n
            setTimeout(() => {
              screenConfirmacion.classList.add('active');
            }, 1000);
          }
        }
        
      } catch (error) {
        console.error('‚ùå Error al llamar al agente:', error);
        if (stepsContainer) {
          stepsContainer.innerHTML = `<div style="color: #ff8888;">Error al procesar su solicitud: ${error.message}</div>`;
        }
      }
    }
    
    // Funciones auxiliares
    function agregarPaso(content, index) {
      try {
        if (!stepsContainer) return;
        
        const stepItem = document.createElement('div');
        stepItem.className = 'step-item processing';
        
        const toolName = content.name || content.tool_name || 'Herramienta desconocida';
        const friendlyName = toolName
          .replace(/([A-Z])/g, ' $1')
          .replace(/^./, str => str.toUpperCase())
          .trim()
          .replace(/\b\w/g, l => l.toUpperCase());
        
        stepItem.innerHTML = `
          <div class="step-title">${escapeHtml(friendlyName)}</div>
          <div class="step-output-content">
            <em style="color: #ffffff;">Herramienta ejecutada correctamente</em>
          </div>
        `;
        
        stepsContainer.appendChild(stepItem);
        
        setTimeout(() => {
          stepItem.classList.remove('processing');
          stepItem.classList.add('completed');
        }, 600);
        
      } catch (err) {
        console.error('Error al agregar paso:', err);
      }
    }
    
    function mostrarResumen(message) {
      try {
        if (!summaryContent || !summarySection) return;
        
        const messageText = typeof message === 'string' ? message : (message.message || JSON.stringify(message, null, 2));
        summaryContent.textContent = messageText;
        summarySection.style.display = 'block';
      } catch (err) {
        console.error('Error al mostrar resumen:', err);
      }
    }
    
    function extraerScoring(texto) {
      if (!texto) return null;
      
      // Buscar patrones como "Scoring: 640", "Scoring:640", "scoring: 640", etc.
      const patrones = [
        /Scoring:\s*(\d+)/i,
        /Scoring\s*:\s*(\d+)/i,
        /score\s*:\s*(\d+)/i
      ];
      
      for (const patron of patrones) {
        const match = texto.match(patron);
        if (match && match[1]) {
          const scoring = parseInt(match[1], 10);
          if (!isNaN(scoring)) {
            return scoring;
          }
        }
      }
      
      return null;
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Detener la c√°mara cuando se cierre la p√°gina
    window.addEventListener('beforeunload', () => {
      stopCamera();
    });
  </script>
</body>
</html>
